# parental-control

## 代码框架

![framework](.\img\framework.svg)

应用层主要提供配置，对外提供API并且实现不同时间的策略切换

内核在linux netfilter的forward处添加了一个钩子，实现了一个过滤器，通过维护group ,rule, app等3个链表元素之间的绑定关系实现设备组，规则集以及应用过滤的需求。

proc文件节点主要提供一些状态，便于调试和获取状态

应用层和内核层的交互通过/dev/parental_control设备实现

### 引用关系

group ,rule, app在/dev/parental_control中的引用关系如下

![relationship ](.\img\relationship .svg)

### 过滤器过滤流程

过滤器的设计尽量保证所有数据高效通过，尽可能减少数据分析对网络性能的消耗

![filter-flow](.\img\filter-flow.svg)



## 特征库语法

特征库为txt文本类型格式，每一行代表一个应用，一个完整的应用描述包括 ID，应用名，以及特征集；

特征集可以由单个或多个特征组成，多个特征之间使用逗号分隔。

#### 应用描述语法

```
id name:[feature1,feature2，feature3]
```

| 字段    | 描述                                                         |
| ------- | ------------------------------------------------------------ |
| id      | 应用ID，全局唯一，是真正用于区分不同应用的字段，增加一个APP时需要组内最大ID加1，如聊天类的appid当前最大为1005，现在增加一个app，则id为1006。<br />appid的组成：分类id和组内id<br />分组id=appid/1000取整，如8001的分类id为8 |
| name    | 应用名字，仅用于直观阅读，不用于应用之间的区分.如微信，百度等 |
| feature | 数据包特征描述，可以包含协议，端口，网址，数据字典等内容，具体见特征描述语法中的内容 |



#### 特征（上表中的feature字段）描述语法

``` 
proto;sport;dport;host;request;dict1|dict2|dict3
```

| 字段    | 描述                                                         |
| ------- | ------------------------------------------------------------ |
| proto   | 传输层协议（tcp或udp）                                       |
| sport   | 源端口                                                       |
| dport   | 目的端口，可以为单个端口，例如8888，也可以为端口范围，例如8888-9999，可以通过叹号对端口取反，例如 !8888 或!8888-9999 |
| host    | 访问的主机或域名，域名支持模糊匹配，如果需要过滤www.baidu.com, 可以只输入baidu |
| request | 请求资源的关键字<br />例如请求www.baidu.com/images/test.png<br />可以配置将request设置为images/test.png<br />需要注意的是，request字段仅支持http，不支持https |
| dict    | 数据字典描述，可以通过数据包中不同位置的数据值来匹配应用，一个特征中可以包括多个数据字典，多个数据字典之间使用\|进行分割，具体请见字典语法中的描述 |



#### 字典（上表中dict字段）描述语法

```
position:value
```

| 字段     | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| position | 网络数据包中data字段中的相对位置（十进制表示），如果该字段为负数，则表示data往前的位置，例如，-1表示在数据包中data字段开始的位置往前偏移一个字节，如果该字段为正数则表示往后偏移。 |
| value    | 对应position位置的数据值（十六进制表示）                     |



## 配置文件

在/etc/config/parental_contorl文件中对应用进行配置，配置文件各部分描述如下

### global

| 字段           | 必要性 | 描述                         |
| -------------- | ------ | ---------------------------- |
| enable         | Y      | 布尔值，是否使能应用         |
| drop_anonymous | Y      | 布尔值，是否禁止匿名设备上网 |
| auto_update    | Y      | 布尔值，是否自动更新特征库   |



### rule

| 字段       | 必要性 | 描述                                                         |
| ---------- | ------ | ------------------------------------------------------------ |
| name       | N      | 字符串，规则名，无实际用途                                   |
| action     | Y      | 字符串，用于设置rule的动作，可能值为DROP,ACCEPT,POLICY_DROP,POLICY_ACCEPT, 其他值将会被忽略 |
| apps       | N      | 整数列表，匹配的应用列表                                     |
| exceptions | N      | 字符串列表，例外特征，需满足特征描述语法                     |
|            |        |                                                              |



### group

| 字段         | 必要性 | 描述                                                         |
| ------------ | ------ | ------------------------------------------------------------ |
| name         | N      | 字符串，规则名，无实际用途                                   |
| default_rule | Y      | 字符串，默认规则，必须对应到一个rule的uci section字段，**注意不是name** |
| macs         | N      | 字符串列表，用户组的mac地址列表，格式为xx:xx:xx:xx:xx:xx     |



### schedule

| 字段  | 必要性 | 描述                                                         |
| ----- | ------ | ------------------------------------------------------------ |
| group | Y      | 字符串，作用于哪个group，必须对应到一个group的uci section字段，**注意不是name** |
| week  | Y      | 整数，作用在一周的那一天，允许范围为1-7，对应周一到周末      |
| begin | Y      | 字符串，在一天的哪个时间点开始,格式为hh:mm:ss                |
| end   | Y      | 字符串，在一天的哪个时间点结束,格式为hh:mm:ss，时间值必须在begin字段的时间值之后 |
| rule  | Y      | 字符串，在begin-end时间段内使用哪个rule, 必须对应到一个rule的uci section字段，**注意不是name** |

